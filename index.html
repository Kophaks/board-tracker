<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Circuit Board Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .table-container { max-height: 60vh; overflow-y: auto; }
    th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
    .sort-icon { opacity: 0.5; transition: opacity 0.2s; }
    th:hover .sort-icon { opacity: 1; }
    #editModal, #historyModal, #drawer { z-index: 50; }
    /* Mobile cards: hide some columns on small screens */
    @media (max-width: 640px) {
      .col-hide-sm { display: none; }
      .row-card { display: block; }
    }
    @media (min-width: 641px) {
      .row-card { display: table-row; }
    }
    /* Slide-out drawer */
    #drawer { transition: transform 0.25s ease; }
    #drawer.closed { transform: translateX(100%); }
    #drawer.open { transform: translateX(0%); }
  </style>
</head>
<body class="antialiased text-gray-800">

<div id="app" class="container mx-auto p-4 md:p-8">
  <header class="mb-6 flex flex-col items-center gap-3">
    <div class="w-full flex items-center justify-between">
      <div>
        <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Board Production Tracker</h1>
        <p class="text-slate-600 mt-1">Collaborative tool to manage your team's circuit board production.</p>
      </div>
      <div class="flex items-center gap-2">
        <button id="exportToggleButton" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300 hidden"
          title="Export & Tools">‚ò∞ Tools</button>
        <button id="loginButton" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 hidden">Sign In with Google</button>
        <button id="logoutButton" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">Sign Out</button>
      </div>
    </div>
    <div id="user-info" class="text-xs text-slate-400 font-mono self-start">Connecting...</div>
  </header>

  <!-- Unauthorized message -->
  <div id="unauthorized" class="hidden text-center text-red-600 font-semibold mb-6">
    üö´ You are not authorized to access this app. Please contact the administrator.
  </div>

  <!-- Filters -->
  <section id="filters" class="bg-white p-4 rounded-xl shadow hidden mb-6">
    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-slate-700 mb-1">Technician</label>
        <select id="technicianFilter" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">All technicians</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">From (production date)</label>
        <input type="date" id="fromDate" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">To (production date)</label>
        <input type="date" id="toDate" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <label class="block text-sm font-medium text-slate-700 mb-1">Search</label>
        <input type="text" id="searchInput" placeholder="Serial / Name / Technician / Date"
          class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
    </div>
    <div class="mt-3 flex gap-2">
      <button id="clearFilters" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Clear</button>
    </div>
  </section>

  <!-- Add Board Form -->
  <section id="add-board-section" class="bg-white p-6 rounded-xl shadow-lg mb-6 hidden">
    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Add New Board(s)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-6 gap-4 items-end">
      <div>
        <label for="technician" class="block text-sm font-medium text-slate-700 mb-1">Technician</label>
        <input type="text" id="technician" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div class="lg:col-span-2">
        <label for="boardName" class="block text-sm font-medium text-slate-700 mb-1">Board Name</label>
        <input type="text" id="boardName" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="e.g., 251_ardal_bridge_v1.1"/>
      </div>
      <div>
        <label for="quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
        <input type="number" id="quantity" value="1" min="1" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="dateInput" class="block text-sm font-medium text-slate-700 mb-1">Production Date (optional)</label>
        <input type="date" id="dateInput" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="comments" class="block text-sm font-medium text-slate-700 mb-1">Initial Comments</label>
        <input type="text" id="comments" placeholder="(Optional)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div class="lg:col-span-6">
        <button id="addBoardButton" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md">Add Board(s)</button>
      </div>
    </div>
  </section>

  <!-- Boards Table -->
  <section id="display-section" class="bg-white p-6 rounded-xl shadow-lg hidden">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-semibold text-slate-800">Boards Produced</h2>
      <div class="text-sm text-slate-500">Sorted by <span id="sortLabel">Date</span></div>
    </div>
    <div class="table-container border border-slate-200 rounded-lg">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-2 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider col-hide-sm">
              <input type="checkbox" id="selectAll" class="h-4 w-4 align-middle hidden">
            </th>
            <th data-sort-by="serialNumber" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer">
              <div class="flex items-center">Serial<span class="sort-icon ml-1.5">‚Üï</span></div>
            </th>
            <th data-sort-by="boardName" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer col-hide-sm">
              <div class="flex items-center">Board Name<span class="sort-icon ml-1.5">‚Üï</span></div>
            </th>
            <th data-sort-by="creationDate" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer">
              <div class="flex items-center">Date<span class="sort-icon ml-1.5">‚Üï</span></div>
            </th>
            <th data-sort-by="technician" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider cursor-pointer">
              <div class="flex items-center">Technician<span class="sort-icon ml-1.5">‚Üï</span></div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Comments</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider col-hide-sm">History</th>
          </tr>
        </thead>
        <tbody id="boardsTableBody" class="bg-white divide-y divide-slate-200"></tbody>
      </table>
      <div id="loading" class="text-center p-6 text-slate-500">Loading‚Ä¶</div>
      <div id="no-results" class="hidden text-center p-6 text-slate-500">No boards found.</div>
    </div>
  </section>
</div>

<!-- Slide-out Drawer -->
<aside id="drawer" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl p-5 closed">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-lg font-semibold text-slate-800">Tools</h3>
    <button id="closeDrawer" class="text-slate-500 hover:text-slate-700">‚úï</button>
  </div>
  <div class="space-y-6">
    <section>
      <h4 class="font-medium text-slate-700 mb-2">Export</h4>
      <p class="text-sm text-slate-500 mb-3">Enable selection mode to choose rows for export.</p>
      <div class="flex gap-2">
        <button id="enableExportMode" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Enable Selection</button>
        <button id="disableExportMode" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Disable</button>
      </div>
      <div class="mt-3 flex flex-col gap-2">
        <button id="exportCSV" class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700" title="Download CSV">Download CSV</button>
        <button id="openSheetsHelp" class="px-3 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200" title="Open Google Sheets help">Open in Google Sheets</button>
        <p id="sheetsHint" class="hidden text-xs text-slate-500">
          Tip: After downloading the CSV, open <a class="underline" href="https://sheets.new" target="_blank" rel="noopener">sheets.new</a> and use <em>File ‚Üí Import ‚Üí Upload</em>.
        </p>
      </div>
    </section>

    <section>
      <h4 class="font-medium text-slate-700 mb-2">Activity Log</h4>
      <p class="text-sm text-slate-500">View per-row edit history via the clock icon in the table.</p>
    </section>
  </div>
</aside>

<!-- Edit Comments Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-slate-800">Edit Comments</h3>
      <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div class="mb-4">
      <label for="modalSerialNumber" class="block text-sm font-medium text-slate-700 mb-1">Serial Number</label>
      <input type="text" id="modalSerialNumber" readonly class="w-full p-2 bg-slate-100 text-slate-500 rounded-md"/>
    </div>
    <div class="mb-6">
      <label for="modalComments" class="block text-sm font-medium text-slate-700 mb-1">Comments</label>
      <textarea id="modalComments" rows="5" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"></textarea>
    </div>
    <div class="flex justify-end gap-3">
      <button id="cancelCommentsButton" class="px-4 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300">Cancel</button>
      <button id="saveCommentsButton" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-slate-800">Activity Log</h3>
      <button id="closeHistoryButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <div id="historyContent" class="max-h-[60vh] overflow-y-auto text-sm text-slate-700 space-y-2">
      <!-- history rows injected here -->
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth, GoogleAuthProvider, signInWithPopup, signInWithRedirect,
    getRedirectResult, signOut, onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, doc, onSnapshot, serverTimestamp,
    getDocs, query, orderBy
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

  // üîπ Replace with your Firebase config
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "1234567890",
    appId: "1:1234567890:web:abcdef"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const appId = "default-board-tracker";
  const boardsCollection = collection(db, "artifacts", appId, "boards");

  const ui = {
    loginBtn: document.getElementById("loginButton"),
    logoutBtn: document.getElementById("logoutButton"),
    userInfo: document.getElementById("user-info"),
    unauthorized: document.getElementById("unauthorized"),
    filters: document.getElementById("filters"),
    addSection: document.getElementById("add-board-section"),
    tableSection: document.getElementById("display-section"),

    addBtn: document.getElementById("addBoardButton"),
    tableBody: document.getElementById("boardsTableBody"),
    loading: document.getElementById("loading"),
    noResults: document.getElementById("no-results"),
    searchInput: document.getElementById("searchInput"),
    technicianFilter: document.getElementById("technicianFilter"),
    fromDate: document.getElementById("fromDate"),
    toDate: document.getElementById("toDate"),
    clearFilters: document.getElementById("clearFilters"),

    technician: document.getElementById("technician"),
    boardName: document.getElementById("boardName"),
    quantity: document.getElementById("quantity"),
    dateInput: document.getElementById("dateInput"),
    comments: document.getElementById("comments"),

    headers: document.querySelectorAll("[data-sort-by]"),
    sortLabel: document.getElementById("sortLabel"),

    // Export
    exportToggle: document.getElementById("exportToggleButton"),
    drawer: document.getElementById("drawer"),
    closeDrawer: document.getElementById("closeDrawer"),
    enableExport: document.getElementById("enableExportMode"),
    disableExport: document.getElementById("disableExportMode"),
    exportCSV: document.getElementById("exportCSV"),
    openSheetsHelp: document.getElementById("openSheetsHelp"),
    sheetsHint: document.getElementById("sheetsHint"),
    selectAll: document.getElementById("selectAll"),

    // Modal
    modal: document.getElementById("editModal"),
    modalSerial: document.getElementById("modalSerialNumber"),
    modalComments: document.getElementById("modalComments"),
    saveButton: document.getElementById("saveCommentsButton"),
    cancelButton: document.getElementById("cancelCommentsButton"),
    closeButton: document.getElementById("closeModalButton"),

    // History
    historyModal: document.getElementById("historyModal"),
    closeHistoryButton: document.getElementById("closeHistoryButton"),
    historyContent: document.getElementById("historyContent"),
  };

  let currentUser = null;
  let allBoards = [];
  let currentSort = { column: "creationDate", direction: "desc" };
  let exportMode = false;
  const selectedIds = new Set();

  // üîê Auth state
  onAuthStateChanged(auth, (user) => {
    currentUser = user;
    if (user) {
      ui.userInfo.textContent = `Connected | ${user.email}`;
      ui.loginBtn.classList.add("hidden");
      ui.logoutBtn.classList.remove("hidden");
      listenBoards();
    } else {
      ui.userInfo.textContent = "Not signed in";
      ui.loginBtn.classList.remove("hidden");
      ui.logoutBtn.classList.add("hidden");
      ui.addSection.classList.add("hidden");
      ui.tableSection.classList.add("hidden");
      ui.filters.classList.add("hidden");
    }
  });

  // üîë Login (popup with redirect fallback)
  ui.loginBtn.addEventListener("click", async () => {
    try {
      const provider = new GoogleAuthProvider();
      await signInWithPopup(auth, provider);
    } catch (err) {
      if (err.code === "auth/operation-not-supported-in-this-environment") {
        const provider = new GoogleAuthProvider();
        await signInWithRedirect(auth, provider);
      }
    }
  });
  getRedirectResult(auth).catch(err => console.error("Redirect failed", err));
  ui.logoutBtn.addEventListener("click", () => signOut(auth));

  // üîÅ Firestore listener
  function listenBoards() {
    onSnapshot(boardsCollection, (snapshot) => {
      ui.loading.classList.add("hidden");
      allBoards = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      ui.addSection.classList.remove("hidden");
      ui.tableSection.classList.remove("hidden");
      ui.filters.classList.remove("hidden");
      ui.unauthorized.classList.add("hidden");
      populateTechnicianFilter();
      render();
    }, (err) => {
      if (err.code === "permission-denied") {
        ui.unauthorized.classList.remove("hidden");
        ui.addSection.classList.add("hidden");
        ui.tableSection.classList.add("hidden");
        ui.filters.classList.add("hidden");
      }
    });
  }

  // ‚ûï Add Boards
  ui.addBtn.addEventListener("click", async () => {
    if (!currentUser) return alert("Please sign in first.");

    const tech = ui.technician.value.trim();
    const name = ui.boardName.value.trim();
    let qty = parseInt(ui.quantity.value, 10);
    const comm = ui.comments.value.trim() || "N/A";

    if (!tech || !name || isNaN(qty) || qty < 1) {
      alert("Please fill in Technician, Board Name, and valid Quantity");
      return;
    }

    const selectedDate = ui.dateInput.value ? new Date(ui.dateInput.value) : new Date();
    const year = String(selectedDate.getFullYear()).slice(-2);
    const month = String(selectedDate.getMonth() + 1).padStart(2, "0");
    const day = String(selectedDate.getDate()).padStart(2, "0");
    const datePart = `${year}${month}${day}`;
    const creationDateString = `${selectedDate.getFullYear()}-${month}-${day}`;
    const boardNumberPart = (name.match(/^\d{3}/) || ["000"])[0];

    for (let i = 0; i < qty; i++) {
      const autonumberPart = String(i + 1).padStart(3, "0");
      const serialNumber = `SN-${datePart}-${boardNumberPart}-${autonumberPart}`;

      const docData = {
        serialNumber,
        boardName: name,
        technician: tech,
        comments: comm,
        creationDate: creationDateString, // visible in UI
        entryDate: serverTimestamp(),     // audit
        createdBy: currentUser.email,     // üëà audit: who created
        updatedBy: currentUser.email,     // initialize as creator
        updatedAt: serverTimestamp()      // initialize
      };

      try {
        await addDoc(boardsCollection, docData);
      } catch (e) {
        alert("Error adding board: " + e.message);
      }
    }

    // Reset form
    ui.technician.value = "";
    ui.boardName.value = "";
    ui.comments.value = "";
    ui.quantity.value = "1";
    ui.dateInput.value = "";
  });

  // üîÉ Render & filters
  function populateTechnicianFilter() {
    const current = ui.technicianFilter.value;
    const techs = Array.from(new Set(allBoards.map(b => (b.technician || "").trim()).filter(Boolean))).sort();
    ui.technicianFilter.innerHTML = `<option value="">All technicians</option>` +
      techs.map(t => `<option value="${t}">${t}</option>`).join("");
    if (current) ui.technicianFilter.value = current;
  }

  function render() {
    const searchTerm = ui.searchInput.value.toLowerCase().trim();
    const techFilter = ui.technicianFilter.value;
    const from = ui.fromDate.value ? new Date(ui.fromDate.value) : null;
    const to = ui.toDate.value ? new Date(ui.toDate.value) : null;

    let filtered = allBoards.filter(board => {
      // Technician filter
      if (techFilter && board.technician !== techFilter) return false;

      // Date range on creationDate
      if (from || to) {
        const d = board.creationDate ? new Date(board.creationDate) : null;
        if (!d) return false;
        if (from && d < new Date(from.getFullYear(), from.getMonth(), from.getDate())) return false;
        if (to && d > new Date(to.getFullYear(), to.getMonth(), to.getDate())) return false;
      }

      // Text search
      if (searchTerm) {
        const hay = [
          board.serialNumber, board.boardName, board.technician,
          board.creationDate, board.comments
        ].map(v => String(v || "").toLowerCase()).join(" ");
        if (!hay.includes(searchTerm)) return false;
      }
      return true;
    });

    // Sorting
    filtered.sort((a, b) => {
      let aVal = a[currentSort.column];
      let bVal = b[currentSort.column];
      // strings (serial, boardName, creationDate, technician)
      aVal = (aVal ?? "").toString().toLowerCase();
      bVal = (bVal ?? "").toString().toLowerCase();
      if (aVal === bVal) return 0;
      const res = aVal > bVal ? 1 : -1;
      return currentSort.direction === "asc" ? res : -res;
    });

    ui.sortLabel.textContent = ({
      serialNumber: "Serial",
      boardName: "Board Name",
      creationDate: "Date",
      technician: "Technician"
    }[currentSort.column] || "Date");

    updateSortIcons();
    populateTable(filtered);
  }

  // üßπ Clear filters
  ui.clearFilters.addEventListener("click", () => {
    ui.technicianFilter.value = "";
    ui.fromDate.value = "";
    ui.toDate.value = "";
    ui.searchInput.value = "";
    render();
  });
  ui.technicianFilter.addEventListener("change", render);
  ui.fromDate.addEventListener("change", render);
  ui.toDate.addEventListener("change", render);
  ui.searchInput.addEventListener("input", render);

  function populateTable(boards) {
    ui.tableBody.innerHTML = "";
    if (boards.length === 0) {
      ui.noResults.classList.remove("hidden");
      return;
    }
    ui.noResults.classList.add("hidden");

    const frag = document.createDocumentFragment();
    boards.forEach(board => {
      const tr = document.createElement("tr");
      tr.className = "row-card hover:bg-slate-50";

      const commentsText = board.comments || "N/A";
      const isChecked = selectedIds.has(board.id) ? "checked" : "";

      tr.innerHTML = `
        <td class="px-2 py-4 text-sm col-hide-sm align-middle">
          <input type="checkbox" data-select-id="${board.id}" class="row-checkbox h-4 w-4 ${exportMode ? '' : 'hidden'}" ${isChecked}>
        </td>
        <td class="px-6 py-4 text-sm font-medium text-slate-900">
          <div class="flex items-center justify-between gap-2">
            <span>${board.serialNumber}</span>
            <button class="sm:hidden text-slate-500 hover:text-slate-700" data-expand="${board.id}" title="Details">‚ñº</button>
          </div>
          <div class="sm:hidden text-xs text-slate-600 mt-2 hidden" data-details="${board.id}">
            <div><span class="font-medium">Board:</span> ${board.boardName}</div>
            <div><span class="font-medium">Date:</span> ${board.creationDate ?? "-"}</div>
            <div><span class="font-medium">Tech:</span> ${board.technician}</div>
            <div class="mt-1"><span class="font-medium">Comments:</span> ${commentsText}</div>
            <div class="mt-1 text-[11px] text-slate-500"><span class="font-medium">Created by:</span> ${board.createdBy || "-"}</div>
          </div>
        </td>
        <td class="px-6 py-4 text-sm text-slate-500 col-hide-sm">${board.boardName}</td>
        <td class="px-6 py-4 text-sm text-slate-500">${board.creationDate ?? "-"}</td>
        <td class="px-6 py-4 text-sm text-slate-500">${board.technician}</td>
        <td class="px-6 py-4 text-sm text-slate-500">
          <div class="flex items-center justify-between gap-2">
            <span class="truncate pr-2" title="${commentsText}">${commentsText}</span>
            <button class="edit-button text-blue-500 hover:text-blue-700 flex-shrink-0" data-id="${board.id}" title="Edit comments">
              ‚úèÔ∏è
            </button>
          </div>
          <div class="text-[11px] text-slate-500 mt-1 col-hide-sm">
            <span class="font-medium">By:</span> ${board.updatedBy || board.createdBy || "-"}
          </div>
        </td>
        <td class="px-4 py-4 text-sm text-slate-500 col-hide-sm">
          <button class="history-button text-slate-500 hover:text-slate-700" data-hist="${board.id}" title="View history">üïí</button>
        </td>
      `;
      frag.appendChild(tr);
    });
    ui.tableBody.appendChild(frag);

    // Row actions
    ui.tableBody.querySelectorAll(".edit-button").forEach(btn => {
      btn.addEventListener("click", () => openEditModal(btn.dataset.id));
    });
    ui.tableBody.querySelectorAll(".history-button").forEach(btn => {
      btn.addEventListener("click", () => openHistoryModal(btn.dataset.hist));
    });
    ui.tableBody.querySelectorAll("[data-expand]").forEach(btn => {
      btn.addEventListener("click", () => {
        const id = btn.dataset.expand;
        const details = ui.tableBody.querySelector(`[data-details="${id}"]`);
        if (details) {
          const hidden = details.classList.toggle("hidden");
          btn.textContent = hidden ? "‚ñº" : "‚ñ≤";
        }
      });
    });
    ui.tableBody.querySelectorAll(".row-checkbox").forEach(cb => {
      cb.addEventListener("change", (e) => {
        const id = e.currentTarget.getAttribute("data-select-id");
        if (e.currentTarget.checked) selectedIds.add(id);
        else selectedIds.delete(id);
        updateSelectAllState();
      });
    });
  }

  // üîÅ Sorting controls
  ui.headers.forEach(h => h.addEventListener("click", () => {
    if (currentSort.column === h.dataset.sortBy) {
      currentSort.direction = currentSort.direction === "asc" ? "desc" : "asc";
    } else {
      currentSort.column = h.dataset.sortBy;
      currentSort.direction = "asc";
    }
    render();
  }));
  function updateSortIcons() {
    ui.headers.forEach(h => {
      const icon = h.querySelector(".sort-icon");
      if (h.dataset.sortBy === currentSort.column) {
        icon.textContent = currentSort.direction === "asc" ? "‚Üë" : "‚Üì";
      } else {
        icon.textContent = "‚Üï";
      }
    });
  }

  // üìù Edit modal
  function openEditModal(boardId) {
    const board = allBoards.find(b => b.id === boardId);
    if (!board) return;
    ui.modalSerial.value = board.serialNumber;
    ui.modalComments.value = board.comments || "";
    ui.saveButton.dataset.docId = board.id;
    ui.saveButton.dataset.oldComments = board.comments || "";
    ui.modal.classList.remove("hidden");
  }
  function closeEditModal() { ui.modal.classList.add("hidden"); }
  ui.cancelButton.addEventListener("click", closeEditModal);
  ui.closeButton.addEventListener("click", closeEditModal);

  ui.saveButton.addEventListener("click", async () => {
    if (!currentUser) return alert("Please sign in first.");
    const docId = ui.saveButton.dataset.docId;
    const oldComments = ui.saveButton.dataset.oldComments || "";
    const newComments = ui.modalComments.value;
    if (!docId) return;

    const boardRef = doc(db, "artifacts", appId, "boards", docId);
    try {
      // update board (updatedBy/updatedAt)
      await updateDoc(boardRef, {
        comments: newComments,
        updatedBy: currentUser.email,
        updatedAt: serverTimestamp()
      });

      // add to history subcollection
      const histRef = collection(db, "artifacts", appId, "boards", docId, "history");
      await addDoc(histRef, {
        action: "update",
        field: "comments",
        oldValue: oldComments,
        newValue: newComments,
        by: currentUser.email,
        at: serverTimestamp()
      });

      closeEditModal();
    } catch (e) {
      alert("Error updating comments: " + e.message);
    }
  });

  // üïí History modal
  async function openHistoryModal(boardId) {
    ui.historyContent.innerHTML = `<div class="text-slate-500">Loading history‚Ä¶</div>`;
    ui.historyModal.classList.remove("hidden");
    try {
      const histCol = collection(db, "artifacts", appId, "boards", boardId, "history");
      const qHist = query(histCol, orderBy("at", "desc"));
      const snap = await getDocs(qHist);
      if (snap.empty) {
        ui.historyContent.innerHTML = `<div class="text-slate-500">No history yet.</div>`;
        return;
      }
      const parts = [];
      snap.forEach(d => {
        const h = d.data();
        const when = h.at?.toDate?.() ? h.at.toDate().toLocaleString() : "-";
        parts.push(`
          <div class="border border-slate-200 rounded-lg p-3">
            <div class="text-slate-800">
              <span class="font-medium">${h.action || "update"}</span> <span class="text-slate-500">on</span> <span class="font-mono">${h.field || "-"}</span>
            </div>
            <div class="mt-1"><span class="text-slate-500 text-xs">By</span> ${h.by || "-"} <span class="text-slate-500 text-xs">at</span> ${when}</div>
            <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
              <div><span class="text-slate-500">Old:</span> ${escapeHTML(h.oldValue ?? "")}</div>
              <div><span class="text-slate-500">New:</span> ${escapeHTML(h.newValue ?? "")}</div>
            </div>
          </div>
        `);
      });
      ui.historyContent.innerHTML = parts.join("");
    } catch (e) {
      ui.historyContent.innerHTML = `<div class="text-red-600">Failed to load history: ${e.message}</div>`;
    }
  }
  ui.closeHistoryButton.addEventListener("click", () => ui.historyModal.classList.add("hidden"));

  // üß≥ Export drawer + selection mode
  ui.exportToggle.addEventListener("click", () => {
    ui.drawer.classList.remove("closed");
    ui.drawer.classList.add("open");
  });
  ui.closeDrawer.addEventListener("click", () => {
    ui.drawer.classList.add("closed");
    ui.drawer.classList.remove("open");
  });
  ui.enableExport.addEventListener("click", () => setExportMode(true));
  ui.disableExport.addEventListener("click", () => setExportMode(false));
  ui.openSheetsHelp.addEventListener("click", () => {
    ui.sheetsHint.classList.toggle("hidden");
    window.open("https://sheets.new", "_blank", "noopener");
  });

  function setExportMode(state) {
    exportMode = state;
    const checkboxes = document.querySelectorAll(".row-checkbox");
    checkboxes.forEach(cb => cb.classList.toggle("hidden", !exportMode));
    ui.selectAll.classList.toggle("hidden", !exportMode);
    if (!exportMode) { selectedIds.clear(); ui.selectAll.checked = false; }
  }

  ui.selectAll.addEventListener("change", (e) => {
    const check = e.currentTarget.checked;
    const checkboxes = document.querySelectorAll(".row-checkbox");
    checkboxes.forEach(cb => {
      cb.checked = check;
      const id = cb.getAttribute("data-select-id");
      if (check) selectedIds.add(id); else selectedIds.delete(id);
    });
  });
  function updateSelectAllState() {
    const checks = Array.from(document.querySelectorAll(".row-checkbox"));
    if (checks.length === 0) { ui.selectAll.checked = false; return; }
    ui.selectAll.checked = checks.every(cb => cb.checked);
  }

  // ‚¨áÔ∏è Export CSV
  ui.exportCSV.addEventListener("click", () => {
    const rows = getExportRows();
    if (rows.length === 0) {
      alert("Nothing selected. Enable selection mode and choose rows, or select all.");
      return;
    }
    const csv = toCSV(rows);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `boards_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  });

  function getExportRows() {
    const ids = selectedIds.size > 0 ? selectedIds : new Set(allBoards.map(b => b.id)); // if none selected, take all
    const pick = allBoards.filter(b => ids.has(b.id));
    // export columns: serialNumber, boardName, creationDate, technician, comments, createdBy, updatedBy, entryDate
    return pick.map(b => ({
      serialNumber: b.serialNumber || "",
      boardName: b.boardName || "",
      creationDate: b.creationDate || "",
      technician: b.technician || "",
      comments: b.comments || "",
      createdBy: b.createdBy || "",
      updatedBy: b.updatedBy || "",
      entryDate: b.entryDate?.toDate?.() ? b.entryDate.toDate().toISOString() : ""
    }));
  }

  function toCSV(arr) {
    const headers = Object.keys(arr[0] || {
      serialNumber:"", boardName:"", creationDate:"", technician:"", comments:"", createdBy:"", updatedBy:"", entryDate:""
    });
    const esc = (v) => `"${String(v).replace(/"/g, '""')}"`;
    const lines = [];
    lines.push(headers.map(esc).join(","));
    for (const row of arr) {
      lines.push(headers.map(h => esc(row[h] ?? "")).join(","));
    }
    return lines.join("\n");
  }

  // üõ°Ô∏è Utils
  function escapeHTML(s) {
    return String(s).replace(/[&<>"']/g, (c) => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
    }[c]));
  }
</script>
</body>
</html>
