<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Circuit Board Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    th { position: sticky; top: 0; background-color: #f9fafb; z-index: 10; }
    .sort-icon { opacity: 0.5; transition: opacity 0.2s; }
    th:hover .sort-icon { opacity: 1; }
    #editModal, #historyModal { z-index: 50; }
  </style>
</head>
<body class="antialiased text-gray-800">

<div id="app" class="container mx-auto p-4 md:p-8">
  <!-- HEADER -->
  <header class="flex justify-between items-center mb-8">
    <div class="text-center flex-1">
      <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Board Production Tracker</h1>
      <p class="text-slate-600 mt-2">Collaborative tool to manage your team's circuit board production.</p>
      <div id="user-info" class="text-xs text-slate-400 mt-2 font-mono">Connecting...</div>
    </div>
    <div class="flex gap-2">
      <button id="exportToggleButton" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-lg hover:bg-slate-300" title="Export & Tools">☰ Tools</button>
      <button id="loginButton" class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Sign In</button>
      <button id="logoutButton" class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 hidden">Sign Out</button>
    </div>
  </header>

  <!-- Unauthorized -->
  <div id="unauthorized" class="hidden text-center text-red-600 font-semibold mb-6">
    🚫 You are not authorized to access this app. Please contact the administrator.
  </div>

  <!-- ADD BOARD -->
  <section id="add-board-section" class="bg-white p-6 rounded-xl shadow-lg mb-8 hidden">
    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Add New Board(s)</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
      <div>
        <label for="technician" class="block text-sm font-medium text-slate-700 mb-1">Technician</label>
        <input type="text" id="technician" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="boardName" class="block text-sm font-medium text-slate-700 mb-1">Board Name</label>
        <input type="text" id="boardName" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="quantity" class="block text-sm font-medium text-slate-700 mb-1">Quantity</label>
        <input type="number" id="quantity" value="1" min="1" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="dateInput" class="block text-sm font-medium text-slate-700 mb-1">Date (optional)</label>
        <input type="date" id="dateInput" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div>
        <label for="comments" class="block text-sm font-medium text-slate-700 mb-1">Initial Comments</label>
        <input type="text" id="comments" placeholder="(Optional)" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      </div>
      <div class="lg:col-span-5">
        <button id="addBoardButton" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 shadow-md">Add Board(s)</button>
      </div>
    </div>
  </section>

  <!-- TABLE + SEARCH -->
  <section id="display-section" class="bg-white p-6 rounded-xl shadow-lg hidden">
    <h2 class="text-2xl font-semibold mb-4 text-slate-800">Boards Produced</h2>
    <div class="mb-4 flex justify-between items-center">
      <input type="text" id="searchInput" placeholder="Search..." class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500"/>
      <button id="toggleFilters" class="ml-3 px-3 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">Advanced Filters</button>
    </div>
    <div id="advancedFilters" class="hidden mb-4 grid grid-cols-1 md:grid-cols-3 gap-3">
      <select id="technicianFilter" class="p-2 border rounded-lg">
        <option value="">All Technicians</option>
      </select>
      <input type="date" id="fromDate" class="p-2 border rounded-lg"/>
      <input type="date" id="toDate" class="p-2 border rounded-lg"/>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200">
        <thead class="bg-slate-50 sm:table-header-group hidden sm:table">
          <tr>
            <th data-sort-by="serialNumber" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer">
              <div class="flex items-center">Serial<span class="sort-icon ml-1.5">↕</span></div>
            </th>
            <th data-sort-by="boardName" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer">
              <div class="flex items-center">Board<span class="sort-icon ml-1.5">↕</span></div>
            </th>
            <th data-sort-by="creationDate" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer">
              <div class="flex items-center">Date<span class="sort-icon ml-1.5">↕</span></div>
            </th>
            <th data-sort-by="technician" class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase cursor-pointer">
              <div class="flex items-center">Technician<span class="sort-icon ml-1.5">↕</span></div>
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase">Comments</th>
          </tr>
        </thead>
        <tbody id="boardsTableBody" class="bg-white divide-y divide-slate-200"></tbody>
      </table>
    </div>
    <div id="loading" class="text-center p-6 text-slate-500">Loading…</div>
    <div id="no-results" class="hidden text-center p-6 text-slate-500">No boards found.</div>
  </section>
</div>

<!-- Edit Modal -->
<div id="editModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-slate-800">Edit Comments</h3>
      <button id="closeModalButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <input type="text" id="modalSerialNumber" readonly class="w-full p-2 bg-slate-100 text-slate-500 rounded-md mb-4"/>
    <textarea id="modalComments" rows="5" class="w-full p-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 mb-4"></textarea>
    <div class="flex justify-end gap-3">
      <button id="cancelCommentsButton" class="px-4 py-2 bg-slate-200 rounded-lg hover:bg-slate-300">Cancel</button>
      <button id="saveCommentsButton" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Save</button>
    </div>
  </div>
</div>

<!-- History Modal -->
<div id="historyModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex justify-center items-center p-4">
  <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-xl font-semibold text-slate-800">Activity Log</h3>
      <button id="closeHistoryButton" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
    </div>
    <ul id="historyList" class="list-disc pl-6 text-slate-700"></ul>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithRedirect,
  getRedirectResult,
  signOut,
  onAuthStateChanged,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  updateDoc,
  doc,
  onSnapshot,
  serverTimestamp,
  getDocs,
  query,
  orderBy,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// 🔹 Replace with your Firebase config
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef",
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const appId = "default-board-tracker";
const boardsCollection = collection(db, "artifacts", appId, "boards");

const ui = {
  loginBtn: document.getElementById("loginButton"),
  logoutBtn: document.getElementById("logoutButton"),
  userInfo: document.getElementById("user-info"),
  unauthorized: document.getElementById("unauthorized"),
  addSection: document.getElementById("add-board-section"),
  tableSection: document.getElementById("display-section"),
  addBtn: document.getElementById("addBoardButton"),
  tableBody: document.getElementById("boardsTableBody"),
  loading: document.getElementById("loading"),
  noResults: document.getElementById("no-results"),
  searchInput: document.getElementById("searchInput"),
  toggleFilters: document.getElementById("toggleFilters"),
  advancedFilters: document.getElementById("advancedFilters"),
  technicianFilter: document.getElementById("technicianFilter"),
  fromDate: document.getElementById("fromDate"),
  toDate: document.getElementById("toDate"),
  technician: document.getElementById("technician"),
  boardName: document.getElementById("boardName"),
  quantity: document.getElementById("quantity"),
  dateInput: document.getElementById("dateInput"),
  comments: document.getElementById("comments"),
  modal: document.getElementById("editModal"),
  modalSerial: document.getElementById("modalSerialNumber"),
  modalComments: document.getElementById("modalComments"),
  saveButton: document.getElementById("saveCommentsButton"),
  cancelButton: document.getElementById("cancelCommentsButton"),
  closeButton: document.getElementById("closeModalButton"),
  historyModal: document.getElementById("historyModal"),
  closeHistoryButton: document.getElementById("closeHistoryButton"),
  historyList: document.getElementById("historyList"),
  exportToggle: document.getElementById("exportToggleButton"),
  headers: document.querySelectorAll("[data-sort-by]"),
};

let allBoards = [];
let currentSort = { column: "creationDate", direction: "desc" };
let exportMode = false;
let currentUser = null;

// 🔹 AUTH STATE
onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    ui.userInfo.textContent = `Connected | ${user.email}`;
    ui.loginBtn.classList.add("hidden");
    ui.logoutBtn.classList.remove("hidden");
    listenBoards();
  } else {
    currentUser = null;
    ui.userInfo.textContent = "Not signed in";
    ui.loginBtn.classList.remove("hidden");
    ui.logoutBtn.classList.add("hidden");
    ui.addSection.classList.add("hidden");
    ui.tableSection.classList.add("hidden");
  }
});

// 🔹 LOGIN / LOGOUT
ui.loginBtn.addEventListener("click", async () => {
  try {
    const provider = new GoogleAuthProvider();
    await signInWithPopup(auth, provider);
  } catch (err) {
    if (err.code === "auth/operation-not-supported-in-this-environment") {
      const provider = new GoogleAuthProvider();
      await signInWithRedirect(auth, provider);
    }
  }
});
getRedirectResult(auth).catch((err) =>
  console.error("Redirect failed", err)
);
ui.logoutBtn.addEventListener("click", () => signOut(auth));

// 🔹 ADD BOARD
ui.addBtn.addEventListener("click", async () => {
  if (!currentUser) return;

  const tech = ui.technician.value.trim();
  const name = ui.boardName.value.trim();
  let qty = parseInt(ui.quantity.value, 10);
  const comm = ui.comments.value.trim() || "N/A";

  if (!tech || !name || isNaN(qty) || qty < 1) {
    alert("Please fill in Technician, Board Name, and valid Quantity");
    return;
  }

  const selectedDate = ui.dateInput.value
    ? new Date(ui.dateInput.value)
    : new Date();
  const year = String(selectedDate.getFullYear()).slice(-2);
  const month = String(selectedDate.getMonth() + 1).padStart(2, "0");
  const day = String(selectedDate.getDate()).padStart(2, "0");
  const datePart = `${year}${month}${day}`;
  const creationDateString = `${selectedDate.getFullYear()}-${month}-${day}`;
  const boardNumberPart = (name.match(/^\d{3}/) || ["000"])[0];

  for (let i = 0; i < qty; i++) {
    const autonumberPart = String(i + 1).padStart(3, "0");
    const serialNumber = `SN-${datePart}-${boardNumberPart}-${autonumberPart}`;

    const docData = {
      serialNumber,
      boardName: name,
      technician: tech,
      comments: comm,
      creationDate: creationDateString,
      entryDate: serverTimestamp(),
      createdBy: currentUser.email,
      updatedBy: currentUser.email,
    };

    try {
      await addDoc(boardsCollection, docData);
    } catch (e) {
      alert("Error adding board: " + e.message);
    }
  }

  ui.technician.value = "";
  ui.boardName.value = "";
  ui.comments.value = "";
  ui.quantity.value = "1";
  ui.dateInput.value = "";
});

// 🔹 LISTEN BOARDS
function listenBoards() {
  onSnapshot(
    query(boardsCollection, orderBy("creationDate", "desc")),
    (snapshot) => {
      ui.loading.classList.add("hidden");
      allBoards = snapshot.docs.map((doc) => ({ id: doc.id, ...doc.data() }));
      ui.addSection.classList.remove("hidden");
      ui.tableSection.classList.remove("hidden");
      populateTechnicianFilter();
      render();
    },
    (err) => {
      if (err.code === "permission-denied") {
        ui.unauthorized.classList.remove("hidden");
        ui.addSection.classList.add("hidden");
        ui.tableSection.classList.add("hidden");
      }
    }
  );
}

// 🔹 RENDER
function render() {
  const searchTerm = ui.searchInput.value.toLowerCase();
  const techFilter = ui.technicianFilter.value;
  const fromDate = ui.fromDate.value;
  const toDate = ui.toDate.value;

  let filtered = allBoards.filter((board) => {
    let match =
      Object.values(board).some((v) =>
        String(v).toLowerCase().includes(searchTerm)
      ) || false;

    if (techFilter && board.technician !== techFilter) return false;
    if (fromDate && board.creationDate < fromDate) return false;
    if (toDate && board.creationDate > toDate) return false;

    return match;
  });

  filtered.sort((a, b) => {
    let aVal = a[currentSort.column] || "";
    let bVal = b[currentSort.column] || "";
    return currentSort.direction === "asc"
      ? aVal > bVal
        ? 1
        : -1
      : aVal < bVal
      ? 1
      : -1;
  });

  updateSortIcons();
  populateTable(filtered);
}

function populateTable(boards) {
  ui.tableBody.innerHTML = "";
  if (boards.length === 0) {
    ui.noResults.classList.remove("hidden");
    return;
  }
  ui.noResults.classList.add("hidden");

  const frag = document.createDocumentFragment();
  boards.forEach((board) => {
    const tr = document.createElement("tr");
    tr.className =
      "hover:bg-slate-50 sm:table-row block border-b sm:border-0";

    const commentsText = board.comments || "N/A";
    tr.innerHTML = `
      <td class="px-6 py-4 text-sm font-medium text-slate-900 block sm:table-cell">
        <span class="sm:hidden font-semibold">Serial: </span>${board.serialNumber}
      </td>
      <td class="px-6 py-4 text-sm text-slate-500 block sm:table-cell">
        <span class="sm:hidden font-semibold">Board: </span>${board.boardName}
      </td>
      <td class="px-6 py-4 text-sm text-slate-500 block sm:table-cell">
        <span class="sm:hidden font-semibold">Date: </span>${board.creationDate}
      </td>
      <td class="px-6 py-4 text-sm text-slate-500 block sm:table-cell">
        <span class="sm:hidden font-semibold">Tech: </span>${board.technician}
      </td>
      <td class="px-6 py-4 text-sm text-slate-500 block sm:table-cell">
        <span class="sm:hidden font-semibold">Comments: </span>${commentsText}
        <div class="mt-2 sm:mt-0 flex justify-end">
          ${
            exportMode
              ? `<input type="checkbox" class="export-check" data-id="${board.id}"/>`
              : `
                <button class="edit-button text-blue-500 hover:text-blue-700 ml-2" data-id="${board.id}">✏️</button>
                <button class="history-button text-slate-500 hover:text-slate-700 ml-2" data-id="${board.id}">📜</button>
              `
          }
        </div>
      </td>
    `;
    frag.appendChild(tr);
  });
  ui.tableBody.appendChild(frag);

  ui.tableBody.querySelectorAll(".edit-button").forEach((btn) =>
    btn.addEventListener("click", () => openEditModal(btn.dataset.id))
  );
  ui.tableBody.querySelectorAll(".history-button").forEach((btn) =>
    btn.addEventListener("click", () => openHistoryModal(btn.dataset.id))
  );
}

// 🔹 SORTING
ui.headers.forEach((h) =>
  h.addEventListener("click", () => {
    if (currentSort.column === h.dataset.sortBy) {
      currentSort.direction =
        currentSort.direction === "asc" ? "desc" : "asc";
    } else {
      currentSort.column = h.dataset.sortBy;
      currentSort.direction = "asc";
    }
    render();
  })
);

function updateSortIcons() {
  ui.headers.forEach((h) => {
    const icon = h.querySelector(".sort-icon");
    if (h.dataset.sortBy === currentSort.column) {
      icon.textContent = currentSort.direction === "asc" ? "↑" : "↓";
    } else {
      icon.textContent = "↕";
    }
  });
}

// 🔹 SEARCH & FILTER
ui.searchInput.addEventListener("input", render);
ui.toggleFilters.addEventListener("click", () => {
  ui.advancedFilters.classList.toggle("hidden");
});
ui.technicianFilter.addEventListener("change", render);
ui.fromDate.addEventListener("change", render);
ui.toDate.addEventListener("change", render);

function populateTechnicianFilter() {
  const techs = [...new Set(allBoards.map((b) => b.technician))];
  ui.technicianFilter.innerHTML = `<option value="">All Technicians</option>`;
  techs.forEach((t) => {
    ui.technicianFilter.innerHTML += `<option value="${t}">${t}</option>`;
  });
}

// 🔹 EDIT MODAL
function openEditModal(id) {
  const board = allBoards.find((b) => b.id === id);
  if (!board) return;
  ui.modalSerial.value = board.serialNumber;
  ui.modalComments.value = board.comments;
  ui.saveButton.dataset.docId = id;
  ui.modal.classList.remove("hidden");
}
function closeEditModal() {
  ui.modal.classList.add("hidden");
}
ui.cancelButton.addEventListener("click", closeEditModal);
ui.closeButton.addEventListener("click", closeEditModal);
ui.saveButton.addEventListener("click", async () => {
  const docId = ui.saveButton.dataset.docId;
  const newComments = ui.modalComments.value;
  if (!docId || !currentUser) return;
  try {
    await updateDoc(doc(db, "artifacts", appId, "boards", docId), {
      comments: newComments,
      updatedBy: currentUser.email,
    });
    await addDoc(collection(db, "artifacts", appId, "boards", docId, "history"), {
      changedBy: currentUser.email,
      field: "comments",
      newValue: newComments,
      changedAt: serverTimestamp(),
    });
    closeEditModal();
  } catch (e) {
    alert("Error updating comments: " + e.message);
  }
});

// 🔹 HISTORY MODAL
async function openHistoryModal(id) {
  ui.historyList.innerHTML = "";
  ui.historyModal.classList.remove("hidden");
  try {
    const q = query(
      collection(db, "artifacts", appId, "boards", id, "history"),
      orderBy("changedAt", "desc")
    );
    const snap = await getDocs(q);
    if (snap.empty) {
      ui.historyList.innerHTML = "<li>No history found</li>";
    } else {
      snap.forEach((doc) => {
        const h = doc.data();
        ui.historyList.innerHTML += `<li>${h.changedBy} updated <b>${h.field}</b> → "${h.newValue}"</li>`;
      });
    }
  } catch (e) {
    ui.historyList.innerHTML = `<li class="text-red-500">Failed to load history: ${e.message}</li>`;
  }
}
ui.closeHistoryButton.addEventListener("click", () =>
  ui.historyModal.classList.add("hidden")
);

// 🔹 EXPORT MODE
ui.exportToggle.addEventListener("click", () => {
  exportMode = !exportMode;
  render();
  if (exportMode) {
    ui.exportToggle.textContent = "✅ Select Entries";
  } else {
    ui.exportToggle.textContent = "☰ Tools";
  }
});
</script>
</body>
</html>

